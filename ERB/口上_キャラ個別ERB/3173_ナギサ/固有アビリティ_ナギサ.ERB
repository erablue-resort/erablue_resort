;--------------------------------------------------
; ナギサ 专属技能
;--------------------------------------------------
;--------------------------------------------------
; 技能 1: 
;--------------------------------------------------
@固有アビ_3173_1(ARGS, キャラ番号)
#DIM キャラ番号
#DIM 消費ＭＰ
#DIMS アビ名
#DIM 隊列番号

    隊列番号 = キャラ隊列検索(キャラ番号)

    IF 基礎BATTLE_STATE:キャラ番号:Lv >= 1
        アビ名 = 
        消費ＭＰ = 0
    ENDIF


    SELECTCASE ARGS
        CASE "アビ名"
            TSTR:コマンド名受渡 = %アビ名%
        
        CASE "アビ説明文"
            IF 基礎BATTLE_STATE:キャラ番号:Lv >= 1
                詳細文文字列受け渡し変数 = 消耗ＭＰ：{消費ＭＰ}<br>
            ENDIF
            RETURN 消費ＭＰ

        CASE "アビ効果"
            IF 基礎BATTLE_STATE:キャラ番号:Lv >= 1
            ENDIF

    ENDSELECT
    RETURN RESULT

;--------------------------------------------------
; 战斗开始时处理 (常驻Buff等)
;--------------------------------------------------
@固有戦闘開始時処理_キャラ_3173
#DIM キャラ番号
#DIM 隊列番号
#DIM バフ・デバフ行数

    キャラ番号 = GETCHARA(3173)
    SIF キャラ番号 < 0
        RETURN 0
    隊列番号 = キャラ隊列検索(キャラ番号)
    SIF 隊列番号 < 0
        RETURN 0
    ; --- 特性: Noblesse oblige ---

       ; CALL アビ対象選択テンプレート_味方全体_生者のみ
       ; CALL アビ汎用変数文字列リセット
  
        FOR LOCAL, 0, 4
            ; その位置にキャラがいて、かつ従業員素質を持っているかを確認する
            IF BATTLE_STATE:LOCAL:属性 == 0 ;基礎BATTLE_STATE:LOCAL:キャラ番号 >= 0 && TALENT:基礎BATTLESTATE:LOCAL:キャラ番号:従業員
                CALL アビ汎用変数文字列リセット
                CALL アビ対象選択テンプレート_指定(LOCAL)
                アビ汎用変数:効果量 = 24
                アビ汎用文字列:バフ・デバフ枠 = Noblesse_oblige
                アビ汎用文字列:バフ・デバフ対象能力 = クリティカル率
                アビ汎用変数:持続ターン = -1
                CALL アビテンプレート_有利効果_バフ効果セット
            ENDIF
        NEXT
        ;IF 装備ステータス補正保存:(アビテンプレート用_対象保存:0):属性 == 10
        ;     アビ汎用変数:効果割合 = 24.2
        ;ENDIF
        ;アビ汎用変数:持続ターン = -1
        ;CALL アビテンプレート_有利効果_バフ効果セット

    RETURN 0


;--------------------------------------------------
; 回合开始时处理 (回复/CD/动态Buff更新)
;--------------------------------------------------
@固有行動開始時処理_キャラ_3173
#DIM キャラ番号
#DIM 隊列番号
#DIM バフ・デバフ行数
#DIM 味方番号
#DIM ＭＡＸ数値
#DIM ＤＭＧキャラ
#DIM 対象指定
    キャラ番号 = GETCHARA(3173)
    SIF キャラ番号 < 0
        RETURN 0
    隊列番号 = キャラ隊列検索(キャラ番号)
    SIF 隊列番号 < 0
        RETURN 0
    ; --- 特性: Afternoon Tea ---
    戦闘中カウント:隊列番号:0 += 1
IF 戦闘中カウント:隊列番号:0 % 5 == 0 ;
    アビ汎用文字列:実行時メッセージ１ = 「素敵なティータイムに音楽は欠かせませんね。」
    アビテンプレート用_アビ名 = Afternoon_Tea

    ＭＡＸ数値 = 0

    FOR 味方番号, 0, 4
        SIF BATTLE_STATE:味方番号:キャラ登録番号 < 1
            CONTINUE
        SIF BATTLE_STATE:味方番号:ＨＰ < 1
            CONTINUE
        SIF BATTLE_STATE:味方番号:最大ＨＰ - BATTLE_STATE:味方番号:ＨＰ == 0
            ;ＨＰが減っていないキャラの場合はその時点でループ終了
            CONTINUE

        ;一番ダメージを受けているキャラクターを指定
        IF BATTLE_STATE:味方番号:最大ＨＰ - BATTLE_STATE:味方番号:ＨＰ > ＭＡＸ数値
            ＭＡＸ数値 = BATTLE_STATE:味方番号:最大ＨＰ - BATTLE_STATE:味方番号:ＨＰ
            ＤＭＧキャラ = 味方番号
        ENDIF
    NEXT

    CALL アビ対象選択テンプレート_指定(ＤＭＧキャラ)
    対象指定 = BATTLE_STATE:(アビテンプレート用_対象保存:0):キャラ登録番号

    IF 固有素質チェック(対象指定, "トリニティ総合学園")
        ;最もＨＰの少ないキャラクターを対象として回復。	
        アビ汎用変数:効果割合 = 393
    ELSE
        ;最もＨＰの少ないキャラクターを対象として回復。
        アビ汎用変数:効果割合 = 279
    ENDIF
    CALL アビテンプレート_回復処理_MAXでも回復
        RETURN 0

ENDIF
    


;--------------------------------------------------
;戦闘能力画面に表示されるキャラごとの固有処理説明
;--------------------------------------------------
@口上_ステータス画面_固有特性解説_3173(対象キャラ)
#DIM 対象キャラ
CALL 口上変数初期化

KSTR:(K++) = □ 特性：Noblesse oblige □-------------------------------------------------------------------
KSTR:(K++) = 　火属性の味方のクリティカル率を24％増加
KSTR:(K++) = □ 特性：Afternoon Tea □-------------------------------------------------------------------
KSTR:(K++) = 　5ターンに、HPが最も低い味方1人に対して回復力の279％分の回復/対象がトリニティ総合学園に所属する生徒の場合、回復力の393％分の回復
CALL 口上変数表示(対象キャラ, 1)
