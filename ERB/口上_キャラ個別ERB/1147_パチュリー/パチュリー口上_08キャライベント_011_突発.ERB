;--------------------------------------------------
;●パチュリー・ノーレッジ口上＠erablue_resort用
;　――突発イベントリスト
;--------------------------------------------------

;--------------------------------------------------
;●ライセンス/更新履歴/概要/使用フラグ
;--------------------------------------------------
;　いずれもパチュリー口上_readme.txt記載に従う
;--------------------------------------------------

;--------------------------------------------------
;〇突発イベントについて
;--------------------------------------------------
;突発イベントは「ならず者の来訪」、「魔物襲撃」などが類例
;わりと複数回発生してもいい感じのイベントだろうか（再発動率もいじれるけど）
;なお、「魔物襲撃」は残しているとデメリットがあるが、それは「AFTERTRA_REPORT.ERB」側で処理追加が必要
;（個人的には、あんまやらんほうがいいと思う）（デメリット、普通イヤなので、「このキャラをリゾートに呼ばない」に傾くかも）
;（やるなら、「金持ちキャラが豪遊！　発生している間、雑務がめっちゃ増える代わりに人気度が増える」とかの、メリットもある形かなあ）
;--------------------------------------------------
;ネタメモ：妖精の慰安旅行
;　レミリアやパッチェさんが常連になっている場合
;　慰安旅行が起こり、妖精メイドがモブとしてやってくる
;　突発イベントの発生中、雑務量が増える代わりに、人気や収入などが増える
;　（日数による消滅前に）突発イベントを実行すると、「そろそろ帰れお前ら！！！」ってことで帰ってイベント終了
;--------------------------------------------------


;--------------------------------------------------
;〇大図書館、フィールドワークに行く
;--------------------------------------------------
;ってことで、パッチェさんが出歩いてリゾートのアレコレを実地調査する感じ
;パッチェさんの好感度が上がるほか、多少の素材が手に入る
;ただし、キャラ独自イベントであるため、発生率は低いし、すぐに消える（将来的に増えたときいっぱいになっても困りそうだし）
;実装は「テンプレ用意されてるから、せっかくだし……」ってモチベ、結構ある。
;--------------------------------------------------
;ところでイベントタイトルは何文字まで行けるのかしら……？
;--------------------------------------------------
;発生条件：パチュリーの信頼度が一定以上、戦闘メンバーがいる、沿岸部の森をクリアしている。かつ、10％
;再発条件：完了後、20日以上経ってから、１日５％
;--------------------------------------------------
;報酬
;・本系アイテム
;・低級素材
;・パッチェさんの信頼度・友情度
;--------------------------------------------------
@イベント発生条件_突発イベント_大図書館、フィールドワークに行く
#DIM 対象キャラ
	;発生した後、「発生してから消滅するまでの日数」の間は絶対に消滅しない
	;消滅までの日数が０になった後、毎朝「消滅する確率」で消滅する。消滅させない場合、下2行を削除すること
	イベント消滅日数渡し = 3
	イベント消滅確率渡し = 100

	;完了した後、「再発生までの日数」の間は絶対に再発生しない
	;再発生までの日数が０になった後、毎朝「再発生する確率」で再発生する。再発生させない場合、下2行を削除すること
	イベント再発生日数渡し = 20
	イベント再発生確率渡し = 5

	;引数で持ってきてないのでここで検索な
	対象キャラ = GETCHARA(1147)

	;バトル系イベントなので、戦闘参加メンバーがいないならダメ（パッチェさんでなくていい）
	SIF BATTLE_STATE:0:0 == 0
		RETURN 0
	;沿岸部の森想定なので、クリアしてないとダメ
	SIF ダンジョンクリアフラグ_沿岸部の森 == 0
		RETURN 0
	;パッチェさんが依頼者なので、パチュリーが滞在していなければ発生しない
	SIF CFLAG:対象キャラ:滞在期間 < 1
		RETURN 0
	;パッチェさんの信頼度などが一定未満だとダメ（今回は「友人」以上でないとダメ）
	SIF CFLAG:対象キャラ:好感度レベル < 関係閾値:3
		RETURN 0
	;ここまで来ても90％の確率でダメ
	SIF RAND:10
		RETURN 0

	;開放条件を満たしたら1を返す
	RETURN 1


;--------------------------------------------------
;条件を満たすと即座に消失させる、あるいは存続させ続けるための関数
;イベント消滅確率渡しがセットされている時のみ読む
;（日数で消滅する場合のみ見るわけだね）
;--------------------------------------------------
@イベント時限消失_消失条件_大図書館、フィールドワークに行く
#DIM 対象キャラ
	;引数で持ってきてないのでここで検索な
	対象キャラ = GETCHARA(1147)

	;パッチェさんがリゾートにいない場合、即座に消滅
	SIF CFLAG:対象キャラ:滞在期間 < 1
		RETURN 1

	;RETURN 0で通常の処理に
	;RETURN 1で即座に消滅
	;RETURN -1で消滅させない
	;例えば「特定のキャラが滞在していない時は消滅」の場合は以下のようになる
	; IF CFLAG:対象キャラ:滞在期間 < 0
	; 	RETURN 1
	; ENDIF

	RETURN 0


;--------------------------------------------------
;条件を満たすと即座に再発生させる、あるいは再発生させないための関数
;イベント再発生確率渡しがセットされている時のみ読む
;（日数で）再発生する場合のみ条件を見る感じかな？
;確率については再発生確率渡しで見ていいと思うけど、「恋慕なら発生率が高くなる」みたいなのをやる場合はこっちかな
;--------------------------------------------------
@イベント時限消失_再発生条件_大図書館、フィールドワークに行く
#DIM 対象キャラ
	;引数で持ってきてないのでここで検索な
	対象キャラ = GETCHARA(1147)

	;パッチェさんがリゾートにいない場合、再発生しない
	SIF CFLAG:対象キャラ:滞在期間 < 1
		RETURN -1

	;RETURN 0で通常の処理に
	;RETURN 1で即座に再発生
	;RETURN -1で再発生させない
	;例えば「特定のキャラが滞在していない時は再発生させない」の場合は以下のようになる
	; IF CFLAG:対象キャラ:滞在期間 < 0
	; 	RETURN -1
	; ENDIF

	;通常処理は５％で再発生な
	RETURN 0


@イベント関数_突発イベント_大図書館、フィールドワークに行く(ARG)
#DIM イベント再発生フラグ
#DIM 対象キャラ
#DIM 敵レベル
#DIM 敵出現数
#DIM イベント完遂フラグ

	;再発生チェック用
	イベント再発生フラグ = DT_CELL_GET("各イベント用変数配列", ARG, "イベント再発生CT")

	;引数で持ってきてないのでここで検索な
	対象キャラ = GETCHARA(1147)

	DRAWLINE
	PRINTL ［大図書館、フィールドワークに行く］
	DRAWLINE
	PRINTFORMW 　
	IF 0
	;パッチェさんが島にいない
	;多分入らないが、おまじない。
	ELSEIF CFLAG:対象キャラ:滞在期間 < 1
		;初回発生
		IF !イベント再発生フラグ
			PRINTFORML ……%CALLNAME:対象キャラ%が、なにか%CALLNAME:MASTER%に頼みごとがあるとか聞いたが……彼女は既に滞在を終えて、帰ってしまっている。
			PRINTFORML 必須ではないのだろうが、ちょっと申し訳ないところだ……
			;これは完遂フラグを立てない。「依頼を受けてないのに２回目」が発生してしまうため。
			;発生日数以内にパッチェさんが来訪したら受注可能
		;２回目以後
		ELSE
			PRINTFORML ……%CALLNAME:対象キャラ%がまたフィールドワークをやりたがっていたが、%CALLNAME:対象キャラ%は滞在を終えて帰ってしまっている……
			PRINTFORML まあ、『一種の観光』と言っていたし、必須ではないのだろうが、ちょっと申し訳ないところだ……
			;イベント完遂扱い。
			;（重要ではないし、パッチェさんもぶっちゃけ次来るときまでに忘れちゃってるので）
			イベント完遂フラグ = 1
		ENDIF
	;初回発生
	ELSEIF !イベント再発生フラグ
		PRINTFORML %CALLNAME:対象キャラ%：
		PRINTFORML 「ちょっとお願いがあるんだけど」
		PRINTFORMW 　
		PRINTFORML %CALLNAME:対象キャラ%は、%CALLNAME:MASTER%を訪ね、そんなふうに言った。
		PRINTFORMW 　
		PRINTFORML %CALLNAME:対象キャラ%：
		PRINTFORML 「別に難しい依頼じゃないわ。
		PRINTFORML 　この島で……沿岸にある森で、フィールドワークをしようと思っているの。
		PRINTFORML 　こちらは幻想郷とは植生もなにもかも違うから。一種の観光ね。
		PRINTFORML 　集中して調査したいから、その間、護衛をお願い。
		PRINTFORML 　いいかしら」
		PRINTFORMW 　
		PRINTFORML 話を聞くに、特に難しい依頼ではなさそうだ。
		PRINTFORML どうしようか？
	;２回目以後
	ELSE
		PRINTFORML %CALLNAME:対象キャラ%：
		PRINTFORML 「またフィールドワークに行きたいのだけど、時間はあるかしら」
		PRINTFORMW 　
		PRINTFORML %CALLNAME:MASTER%を訪ねてきた%CALLNAME:対象キャラ%は、そんなふうに言った。
		PRINTFORML 前回と同じく、フィールドワークに付き合ってほしい、ということらしい。
		PRINTFORMW 　
		PRINTFORML 特に難しい依頼ではない。
		PRINTFORML どうしようか？
	ENDIF

	PRINTFORMW 　
	PRINTFORML 沿岸部の森でフィールドワークを行う%CALLNAME:対象キャラ%を護衛します。準備はよろしいですか？
	PRINTBUTTON "[0] 依頼を受諾する", 0
	PRINTFORMW 　
	PRINTBUTTON "[1] ちょっと待ってもらう", 1
	PRINTFORMW 　
	BINPUT
	IF 0
	;依頼拒否
	;受諾すると長くなるので短いほうを先にしちゃうね！
	ELSEIF RESULT == 1
		PRINTFORMW 　
		PRINTFORML ちょっと待ってほしい――そう伝えると、%CALLNAME:対象キャラ%は特に感慨もなく頷いた。
		PRINTFORMW 　
		PRINTFORML %CALLNAME:対象キャラ%：
		PRINTFORML 「分かったわ。
		PRINTFORML 　%CSTR:対象キャラ:一人称%は――まあ、本を読むのは忙しいけれど、逃げないから。
		PRINTFORML 　いつでもいいから、%CSTR:対象キャラ:二人称%が暇なときに声をかけて」
		PRINTFORMW 　
		PRINTFORML そんなふうに言って、%CALLNAME:対象キャラ%はフワフワと飛んでいった……
	;依頼受諾
	ELSEIF RESULT == 0
		PRINTFORMW 　
		PRINTFORML ………………
		PRINTFORML …………
		PRINTFORML ……
		PRINTW 　
		PRINTFORML %CALLNAME:対象キャラ%は、植物と図鑑を見比べたり、キノコを収穫したり、小動物をスケッチしたりしている。
		PRINTFORML （幻想郷に持ち帰って蔵書にするつもりなのだろうか？）
		PRINTFORML 邪魔にならないように、付かず離れずの位置で、（ついでに木材などを採取しつつ）待機していると――
		PRINTFORML ――精霊たちが、近づいてくるのが見えた。
		PRINTFORML そう危険ではないが、邪魔ではあろう。
		PRINTFORML %CALLNAME:MASTER%は%CALLNAME:対象キャラ%に声をかけ、戦闘を開始する。
		PRINTFORMW 　
		PRINTFORML %CALLNAME:対象キャラ%：
		PRINTFORML 「任せたわね」
		PRINTFORMW 　
		PRINTFORML ……そのままフィールドワーク続行するのはさすがにどうかと思うなぁ！
		PRINTW 　

		;戦闘処理の開始
		;出現数は２～５
		敵出現数 = RAND:4 + 2
		;敵レベルは２～５
		敵レベル = RAND:4 + 2

		CALL イベント戦闘初期処理()
		;敵セット
		FOR LOCAL, 0, 敵出現数
			敵BATTLE_STATE_STR:LOCAL:エネミー名 = Lv2_風のエレメンタル
			敵BATTLE_STATE:LOCAL:ランダムエネミーフラグ = 敵レベル
		NEXT
			;こういうのもあるけど……まあ、固定でいいでしょ
			;＞CALL ランダムエネミーセット関数(エネミー数, レベル目安)

		CALL イベント中戦闘用処理()
		;人生の勝利者
		IF RESULT == 0
			PRINTFORMW 　
			PRINTFORML ………………
			PRINTFORML …………
			PRINTFORML ……
			PRINTW 　
			PRINTFORMW 　
			PRINTFORML しばらくして、%CALLNAME:対象キャラ%は本を閉じた。
			PRINTFORML フィールドワークに満足したか、あるいは外歩きで疲れたのか、そろそろ帰るつもりらしい。
			PRINTFORMW 　
			PRINTFORML %CALLNAME:対象キャラ%：
			IF 陥落チェック(対象キャラ)
				PRINTFORML 「……ありがとう。付き合ってくれて」
			ELSE
				PRINTFORML 「ありがとう。満足したわ」
			ENDIF
			PRINTFORMW 　
			PRINTFORML リゾートのオーナーとして、お客様のご要望にお答えするのは当然のことだ――そんなふうに答え、%CALLNAME:MASTER%たちは帰路に着く。
			;陥落分岐
			IF パッチェさん_陥落段階(対象キャラ, "未陥落")
				PRINTFORML 星晶獣eraの力もあるとはいえ、通常の手段で仲良くなっておくに越したことはない……。
			ELSE
				;陥落してるとむしろなんも言わない
			ENDIF
			PRINTFORMW 　

			;イベント再視聴で無限に稼ぎが出来たりしないようにする措置
			IF !FLAG:クリア済み視聴フラグ
				;報酬
				LOCAL = RAND:100
				;陥落していると、いいものが出やすくなる
				SIF 陥落チェック(対象キャラ) && LOCAL > 80
					LOCAL = RAND:80

				IF 0
				ELSEIF LOCAL < 10
					LOCALS = 入手困難な名著
				ELSEIF LOCAL < 40
					LOCALS = 流行りの小説本
				ELSE
					LOCALS = ありふれた娯楽本
				ENDIF
				CALL 素材入手処理(LOCALS, 1)
				PRINTFORML %CALLNAME:MASTER%は%CALLNAME:対象キャラ%からお礼に「%LOCALS%」を貰った。

				;薬草は確定入手
				CALL アイテム増減汎用処理("薬草", 敵出現数)
				;他は確率。低級素材。
				IF !RAND:2
					LOCALS = 普通の野菜
					CALL 素材入手処理(LOCALS, 敵レベル)
				ENDIF
				IF !RAND:2
					LOCALS = 雑穀
					CALL 素材入手処理(LOCALS, 敵レベル)
				ENDIF
				IF !RAND:2
					LOCALS = 普通の木材
					CALL 素材入手処理(LOCALS, 敵レベル)
				ENDIF
				PRINTFORML 護衛中に集めていた薬草や素材を倉庫に収めた。
				
				;パッチェさんの信頼度上昇
				;結構大きい上昇量だが、「自室に遊びに来た」のが信頼度+250なので、それよりもうちょっと関わる、という値
				CALL SOURCE_CALC_好感度要素_友情度UP(TARGET, PLAYER, 300)
				CALL SOURCE_CALC_好感度要素_信頼度UP(対象キャラ, MASTER, 300)
			ELSE
				PRINTFORML %CALLNAME:MASTER%は%CALLNAME:対象キャラ%からお礼に「ありふれた娯楽本」を貰った。
				PRINTFORML 護衛中に集めていた薬草や素材を倉庫に収めた。
				PRINTFORML （回想中なので素材は手に入らなかった……）
			ENDIF

			;イベント完遂
			イベント完遂フラグ = 1
		;全滅
		ELSEIF RESULT == 1
			PRINTFORMW 　
			PRINTFORML これはまずい。一時退却しよう。
			PRINTFORML %CALLNAME:対象キャラ%をお米さま抱っこして、%CALLNAME:MASTER%は逃げ出した……
			PRINTFORMW 　
			PRINTFORML %CALLNAME:対象キャラ%：
			PRINTFORML 「あとでもう一回ね。もう少し続けたいわ」
			PRINTFORMW 　
			PRINTFORML もう一回行けと申すか、学者先生。
		;逃走
		ELSEIF RESULT == -1
			PRINTFORMW 　
			PRINTFORML これはまずい。一時退却しよう。
			PRINTFORML %CALLNAME:対象キャラ%をお米さま抱っこして、%CALLNAME:MASTER%は逃げ出した……
			PRINTFORMW 　
			PRINTFORML %CALLNAME:対象キャラ%：
			PRINTFORML 「あとでもう一回ね。もう少し続けたいわ」
			PRINTFORMW 　
			PRINTFORML もう一回行けと申すか、学者先生。
		ENDIF
		;戦闘終了処理
		CALL ダンジョン終了時処理
	ENDIF

	;最後に止めたい、ぷりんとW
	PRINTW 　

	;イベント完遂したかどうか（＝イベント消滅するかどうか）
	SIF イベント完遂フラグ
		CALL イベント完了フラグ汎用処理("大図書館、フィールドワークに行く")





