@固有奥義_2317(ARGS, キャラ番号)
#DIM キャラ番号
#DIM 奥義威力
#DIM 隊列番号
#DIMS 奥義名
#DIM 消費段階
#DIM 竜判定
#DIM ゲージ上昇効率値
#DIM 攻撃力上昇値
#DIM 防御力下降値

隊列番号 = キャラ隊列検索(キャラ番号)
竜判定 = バフ番号取得_枠("境界を拓く、最後の竜", 隊列番号)


;--------------------------------------------
; 奥义槽上限固定
;--------------------------------------------
IF 隊列番号 > -1
	BATTLE_STATE:隊列番号:ゲージ最大値 = 300
ENDIF

;--------------------------------------------
; 龙 / 非龙判定
;--------------------------------------------
IF 竜判定 > -1
	奥義名 = 无人知晓的无垢搏动
	奥義威力 = 0

	消費段階 = 100
	攻撃力上昇値 = 30

	IF 隊列番号 > -1
		IF BATTLE_STATE:隊列番号:奥義ゲージ >= 300
			消費段階 = 300
			攻撃力上昇値 = 60
		ELSEIF BATTLE_STATE:隊列番号:奥義ゲージ >= 200
			消費段階 = 200
			攻撃力上昇値 = 50
		ENDIF
	ENDIF
ELSE
	奥義名 = 尚未知晓的无垢湖光

	消費段階 = 100
	奥義威力 = 500
	ゲージ上昇効率値 = 30
	防御力下降値 = 10

	IF 隊列番号 > -1
		IF BATTLE_STATE:隊列番号:奥義ゲージ >= 300
			消費段階 = 300
			奥義威力 = 900
			ゲージ上昇効率値 = 60
		ELSEIF BATTLE_STATE:隊列番号:奥義ゲージ >= 200
			消費段階 = 200
			奥義威力 = 700
			ゲージ上昇効率値 = 45
		ENDIF
	ENDIF
ENDIF

	
	;--------------------------------------------
	; 必要 / 实际消耗奥义槽
	;--------------------------------------------
	アビ汎用変数:必要奥義ゲージ量 = 消費段階
	アビ汎用変数:消費奥義ゲージ量 = 消費段階

SELECTCASE ARGS
	CASE "奥義名"
		TSTR:コマンド名受渡 = %奥義名%
		IF 隊列番号 > -1
			SIF BATTLE_STATE:隊列番号:奥義ゲージ < 消費段階
				RETURN 1
		ENDIF
		
	CASE "奥義説明文"
		詳細文文字列受け渡し変数 = 消耗奥义槽：100／200／300
		詳細文文字列受け渡し変数 += @"<br>当前消耗奥义槽：{消費段階}"
		
		IF 竜判定 > -1
			;誰も知らぬ、無垢なる鼓動的说明
			詳細文文字列受け渡し変数 += @"<br>自身に攻撃力［{攻撃力上昇値}％］（独立枠・3ターン）を付与する。"
			IF 消費段階 == 300
				詳細文文字列受け渡し変数 += @"<br>敵全体に［攻撃力×500％］の自身属性ダメージを与える。"
			ELSEIF 消費段階 == 200
				詳細文文字列受け渡し変数 += @"<br>敵全体に［攻撃力×450％］の自身属性ダメージを与える。"
			ELSE
				詳細文文字列受け渡し変数 += @"<br>敵全体に［攻撃力×300％］の自身属性ダメージを与える。"
			ENDIF
			詳細文文字列受け渡し変数 += @"<br>敵全体にやけど［1000］（5ターン）を付与する。"
		ELSE
			;今は知らず、無垢なる湖光的说明
			詳細文文字列受け渡し変数 += @"<br>自身に奥義ゲージ上昇量［{ゲージ上昇効率値}％］（独立枠・3ターン）を付与する。"
			詳細文文字列受け渡し変数 += @"<br>敵単体に［攻撃力×{奥義威力}％］の自身属性ダメージを与える。"
			詳細文文字列受け渡し変数 += @"<br>防御力ダウン［累積{防御力下降値}％／最大50％］（累積枠・3ターン）を付与する。"
			詳細文文字列受け渡し変数 += @"<br>自身にクリティカルダメージ［20％］（独立枠・3ターン）を付与する。"
		ENDIF
		RETURN 奥義威力
		
	CASE "奥義説明文_詳細"
		詳細文文字列受け渡し変数 = 消耗奥义槽：100／200／300
		詳細文文字列受け渡し変数 += @"<br>当前消耗奥义槽：{消費段階}"
		
		IF 竜判定 > -1
			詳細文文字列受け渡し変数 += @"<br>自身に攻撃力［{攻撃力上昇値}％］（独立枠・3ターン）を付与する。"
			IF 消費段階 == 300
				詳細文文字列受け渡し変数 += @"<br>敵全体に［攻撃力×500％］の自身属性ダメージを与える。"
			ELSEIF 消費段階 == 200
				詳細文文字列受け渡し変数 += @"<br>敵全体に［攻撃力×450％］の自身属性ダメージを与える。"
			ELSE
				詳細文文字列受け渡し変数 += @"<br>敵全体に［攻撃力×300％］の自身属性ダメージを与える。"
			ENDIF
			詳細文文字列受け渡し変数 += @"<br>敵全体にやけど［1000］（5ターン）を付与する。"
		ELSE
			詳細文文字列受け渡し変数 += @"<br>自身に奥義ゲージ上昇量［{ゲージ上昇効率値}％］（独立枠・3ターン）を付与する。"
			詳細文文字列受け渡し変数 += @"<br>敵単体に［攻撃力×{奥義威力}％］の自身属性ダメージを与える。"
			詳細文文字列受け渡し変数 += @"<br>防御力ダウン［累積{防御力下降値}％／最大50％］（累積枠・3ターン）を付与する。"
			詳細文文字列受け渡し変数 += @"<br>自身にクリティカルダメージ［20％］（独立枠・3ターン）を付与する。"
		ENDIF
		
	CASE "奥義前効果"
		;処理の都合上、ここから奥義ダメージまでにリセットを噛ませてないため
		;必要な場合を除きここでリセット
		CALL アビ汎用変数文字列リセット
		
	CASE "奥義追加効果"
		IF 竜判定 > -1
			;誰も知らぬ、無垢なる鼓動的效果
			
			;自身攻击力提升
			CALL アビ汎用変数文字列リセット
			CALL アビ対象選択テンプレート_自己のみ
			アビ汎用文字列:バフ・デバフ枠 = 誰も知らぬ、無垢なる鼓動_攻撃力
			アビ汎用文字列:バフ・デバフ対象能力 = 攻撃力
			アビ汎用変数:効果割合 = 攻撃力上昇値
			アビ汎用変数:持続ターン = 3
			CALL アビテンプレート_有利効果_バフ効果セット
			
			;对敌全体造成伤害
			CALL アビ汎用変数文字列リセット
			CALL アビ対象選択テンプレート_敵全体_生者のみ
			IF 消費段階 == 300
				アビ汎用変数:効果割合 = 500
			ELSEIF 消費段階 == 200
				アビ汎用変数:効果割合 = 450
			ELSE
				アビ汎用変数:効果割合 = 300
			ENDIF
			CALL アビテンプレート_ダメージ処理_自属性
			
			;赋予火伤
			CALL アビ汎用変数文字列リセット
			アビ汎用文字列:バフ・デバフ枠 = 火傷
			アビ汎用文字列:バフ・デバフ対象能力 = 火傷
			アビ汎用変数:効果量 = 1000
			アビ汎用変数:持続ターン = 5
			アビ汎用変数:基礎成功確率 = 100
			CALL アビテンプレート_不利効果_デバフ効果セット
			
		ELSE
			;今は知らず、無垢なる湖光的效果
				

	アビ汎用文字列:バフ・デバフ枠 = 防御力累積
	アビ汎用文字列:バフ・デバフ対象能力 = 防御力
	アビ汎用変数:効果割合 = 防御力下降値
	アビ汎用変数:累積上限_割合 = 50
	アビ汎用変数:持続ターン = 3
	アビ汎用変数:基礎成功確率 = 100
	CALL アビテンプレート_不利効果_累積デバフ効果セット

	アビ汎用変数:効果割合 = 奥義威力
	CALL アビテンプレート_ダメージ処理_自属性	
	
			CALL アビ汎用変数文字列リセット
			CALL アビ対象選択テンプレート_自己のみ
			アビ汎用文字列:バフ・デバフ枠 = 今は知らず、無垢なる湖光_CT倍率
			アビ汎用文字列:バフ・デバフ対象能力 = クリティカルダメージ率
			アビ汎用変数:効果割合 = 20
			アビ汎用変数:持続ターン = 3
			CALL アビテンプレート_有利効果_バフ効果セット

			CALL アビ汎用変数文字列リセット
			CALL アビ対象選択テンプレート_自己のみ
			アビ汎用文字列:バフ・デバフ枠 = 今は知らず、無垢なる湖光_GE率
			アビ汎用文字列:バフ・デバフ対象能力 = ゲージ上昇効率
			アビ汎用変数:効果割合 = ゲージ上昇効率値
			アビ汎用変数:持続ターン = 3
			CALL アビテンプレート_有利効果_バフ効果セット
		ENDIF
ENDSELECT

RETURN RESULT


@KOJO_DUNGEON_奥義発動時_2317(対象キャラ, 使用奥義名)
#DIM 対象キャラ
#DIMS 使用奥義名
#DIM 竜判定

CALL 口上変数初期化

LOCAL = キャラ隊列検索(対象キャラ)
LOCAL:竜判定 = バフ番号取得_枠("境界を拓く、最後の竜", LOCAL)

SELECTCASE RAND:3
	CASE 0
		IF LOCAL:竜判定 > -1
			WSTR:(K++) = 「この名はアルビオン。境界を拓く最後の竜……！」
			KSTR:(K++) = 「ジョフロアからフロモンへ。時を示せ、 デュケイダイト……！」
		ELSE
			WSTR:(K++) = 「真名、偽装展開。清廉たる湖面、月光を返す！」
			KSTR:(K++) = 「沈め、『今は知らず、無垢なる湖光』！」
		ENDIF

	CASE 1
		IF LOCAL:竜判定 > -1
			WSTR:(K++) = 「朽ちる骸より出でよ。炎の息、鉄の翼。」
			KSTR:(K++) = 「黄昏の空に、産声のように……！『誰も知らぬ、無垢なる鼓動』！」
		ELSE
			WSTR:(K++) = 「一撃、一瞬で終わらせる。切開剣技、開始。」
			KSTR:(K++) = 「繋げ、『今は知らず、無垢なる湖光』！」
		ENDIF

	CASE 2
		IF LOCAL:竜判定 > -1
			WSTR:(K++) = 「飛びなさい、彼方の空へ……！おまえは、たとえ残骸であろうとも……！」
			KSTR:(K++) = 「あぁ、これで——」
		ELSE
			WSTR:(K++) = 「は、もう私のモノだ。血も肉も零さない……」
			KSTR:(K++) = 「深い水底に連れて行こう！」
		ENDIF
ENDSELECT

CALL メッセージ欄表示用関数(@"探索用_{LOCAL}_顔", CALLNAME:対象キャラ,,0,,対象キャラ)
RETURN